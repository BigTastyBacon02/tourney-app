<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>1×1 Auswahl – Promi-Raten (Custom Pics)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1f6feb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="1×1 Auswahl">
  <link rel="apple-touch-icon" href="icon-180.png">
  <style>
    :root{--bg:#0b0c0f;--card:#111317;--text:#e6e7ea;--line:#1c1f26;--brand:#1f6feb;--muted:#9aa3b2}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:8px 0}
    textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1218;color:var(--text);font-size:16px}
    .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .pri{background:var(--brand);color:#fff}
    .sec{background:#161a22;color:var(--text);border:1px solid var(--line)}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;margin:4px;border-radius:999px;background:#161a22;border:1px solid var(--line)}
    .thumb{width:20px;height:20px;border-radius:6px;object-fit:cover}
    .pair{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start;margin-top:8px}
    .opt{display:flex;flex-direction:column;gap:10px}
    .bigimg{width:240px;height:240px;object-fit:cover;border-radius:14px;border:1px solid var(--line);background:#0f131a}
    .opt button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#18202b;color:var(--text);font-weight:800}
    .mini{font-size:12px;color:var(--muted)}
    .gal{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
    .gal img{width:76px;height:76px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#0f131a;flex:0 0 auto;cursor:pointer}
    .src{font-size:11px;color:var(--muted)}
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:999999}
    .lightbox img{max-width:90vw;max-height:85vh;border-radius:12px;border:1px solid #333}
    .addbar{display:flex;gap:8px;align-items:center}
    input[type=file]{display:none}
    .chip{border:1px dashed var(--line);border-radius:10px;padding:6px 10px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <h1>1×1 Auswahl – Promi-Raten</h1>
  <div class="card">
    <div class="row">
      <label class="mini">Ziel-Anzahl<br><input id="target" type="number" value="1" min="1"></label>
      <label class="mini">Erwachsenenmodus (zeigt ggf. sensible Bilder)<br><input id="adult" type="checkbox" checked></label>
      <button id="startBtn" class="btn pri">Starten</button>
      <button id="demoBtn" class="btn sec">Demo</button>
    </div>
    <textarea id="names" placeholder="Name 1
Name 2
Name 3"></textarea>
    <div class="mini" style="margin-top:6px">Tipp: Du kannst eigene Bilder hinzufügen (URL einfügen oder Datei auswählen). Diese werden lokal gespeichert und bei diesem Namen zuerst verwendet.</div>
  </div>

  <div class="layout">
    <div class="card">
      <h3 style="margin:0 0 6px">Drin <span class="mini" id="cntIn">0</span></h3>
      <div id="listIn"></div>
      <h3 style="margin:10px 0 6px">Raus <span class="mini" id="cntOut">0</span></h3>
      <div id="listOut"></div>
    </div>

    <div class="card">
      <div id="arena" style="display:none">
        <div class="pair">
          <div class="opt">
            <img id="li" class="bigimg" alt="links">
            <div class="addbar">
              <input id="lfile" type="file" accept="image/*">
              <button id="ladd" class="btn sec">Bild hinzufügen</button>
              <span class="chip" id="lhost">–</span>
            </div>
            <div class="gal" id="lgal"></div>
            <button id="leftBtn">–</button>
            <div class="src"><a id="lg" href="#" target="_blank">Quelle</a></div>
          </div>
          <div style="align-self:center">vs</div>
          <div class="opt">
            <img id="ri" class="bigimg" alt="rechts">
            <div class="addbar">
              <input id="rfile" type="file" accept="image/*">
              <button id="radd" class="btn sec">Bild hinzufügen</button>
              <span class="chip" id="rhost">–</span>
            </div>
            <div class="gal" id="rgal"></div>
            <button id="rightBtn">–</button>
            <div class="src"><a id="rg" href="#" target="_blank">Quelle</a></div>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="undoBtn" class="btn sec" disabled>Rückgängig</button>
          <button id="shuffleBtn" class="btn sec">Neu mischen</button>
          <div class="mini" id="status"></div>
        </div>
      </div>
      <div id="result" style="display:none">
        <h3 style="margin:0 0 6px">Übrig</h3>
        <div id="survivors"></div>
      </div>
    </div>
  </div>

  <div class="lightbox" id="lb"><img id="lbimg" alt=""></div>

<script>
const $=s=>document.querySelector(s);
const namesEl=$('#names'), targetEl=$('#target'), adultEl=$('#adult');
const startBtn=$('#startBtn'), demoBtn=$('#demoBtn');
const arena=$('#arena'), result=$('#result'), survivors=$('#survivors');
const li=$('#li'), ri=$('#ri'), lgal=$('#lgal'), rgal=$('#rgal');
const leftBtn=$('#leftBtn'), rightBtn=$('#rightBtn');
const lg=$('#lg'), rg=$('#rg'), undoBtn=$('#undoBtn'), shuffleBtn=$('#shuffleBtn');
const listIn=$('#listIn'), listOut=$('#listOut'), cntIn=$('#cntIn'), cntOut=$('#cntOut'), status=$('#status');
const lb=$('#lb'), lbimg=$('#lbimg');
const ladd=$('#ladd'), radd=$('#radd'), lfile=$('#lfile'), rfile=$('#rfile'), lhost=$('#lhost'), rhost=$('#rhost');

let pool=[], out=[], currentPair=[], history=[], target=1;
const cachePrimary={}, cacheGalleries={}, localMap={}, localGallery={}, LS_KEY='customPicsV1';

// ---- Load pics/index.json (repo-based) ----
async function loadRepoMapping(){
  try{
    const r = await fetch('./pics/index.json'); if(!r.ok) return;
    const j = await r.json();
    if (j && typeof j === 'object'){
      const m = j;
      if (m && !m.mapping_example) Object.assign(localMap, m);
    }
  }catch(e){}
}
// ---- Helpers ----
function uniq(a){return Array.from(new Set(a));}
function hostOf(u){try{return new URL(u).host;}catch(e){return '';}}
function slug(s){return s.toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');}
function lightbox(src){ lbimg.src=src; lb.style.display='flex'; }
lb.addEventListener('click', ()=>{ lb.style.display='none'; lbimg.src=''; });

// ---- Local Storage (user-added images) ----
function loadLocal(){
  try{
    const j = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    Object.assign(localGallery, j);
  }catch(e){}
}
function saveLocal(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(localGallery));
  }catch(e){}
}

async function fileToDataURL(file, maxW=512){
  const img = document.createElement('img');
  const fr = new FileReader();
  const p = new Promise((res,rej)=>{
    fr.onload = ()=>{ img.onload = ()=>{
        // resize
        const scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
        const cnv = document.createElement('canvas'); cnv.width=w; cnv.height=h;
        const ctx=cnv.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        res(cnv.toDataURL('image/jpeg', 0.9));
      }; img.onerror = rej; img.src = fr.result;
    };
    fr.onerror = rej;
  });
  fr.readAsDataURL(file);
  return p;
}

// ---- External sources (same as before) ----
const WD_SEARCH = 'https://www.wikidata.org/w/api.php?action=wbsearchentities&format=json&origin=*&language=en&uselang=en&type=item&limit=5&search=';
const WD_GET = 'https://www.wikidata.org/w/api.php?action=wbgetentities&format=json&origin=*&props=claims&ids=';

async function wikidataLookup(name){
  let q = await fetch(WD_SEARCH + encodeURIComponent(name)).then(r=>r.json()).catch(()=>null);
  if(!q || !q.search || !q.search.length){
    q = await fetch(WD_SEARCH.replace('language=en','language=de').replace('uselang=en','uselang=de') + encodeURIComponent(name)).then(r=>r.json()).catch(()=>null);
  }
  if(!q || !q.search || !q.search.length) return null;
  return q.search[0].id;
}
function claimImageFilename(entity){
  const cl = entity && entity.claims && entity.claims.P18; if(!cl||!cl.length) return null;
  const v = cl[0].mainsnak.datavalue && cl[0].mainsnak.datavalue.value; return v||null;
}
function claimCommonsCategory(entity){
  const cl = entity && entity.claims && entity.claims.P373; if(!cl||!cl.length) return null;
  const v = cl[0].mainsnak.datavalue && cl[0].mainsnak.datavalue.value; return v||null;
}
function commonsFileURL(filename,width=400){
  return 'https://commons.wikimedia.org/wiki/Special:FilePath/'+encodeURIComponent(filename)+'?width='+width;
}
async function commonsCategoryThumbs(cat, n=10, width=320){
  const ep='https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&generator=categorymembers&gcmtype=file&gcmlimit='+n+'&gcmtitle=Category:'+encodeURIComponent(cat)+'&prop=imageinfo&iiprop=url&iiurlwidth='+width;
  try{
    const r=await fetch(ep); const j=await r.json();
    if(!(j&&j.query&&j.query.pages)) return [];
    const pages=Object.values(j.query.pages);
    return pages.map(p=>{
      const ii=p.imageinfo&&p.imageinfo[0]; if(!ii) return null;
      const src=ii.thumburl||ii.url; const credit='https://commons.wikimedia.org/wiki/File:'+encodeURIComponent(p.title.replace('File:',''));
      return {src, creditUrl: credit};
    }).filter(Boolean);
  }catch(e){ return []; }
}
async function openverseThumbs(name,n=10,allowMature=true){
  const u='https://api.openverse.engineering/v1/images/?q='+encodeURIComponent(name)+'&page_size='+n+(allowMature?'&mature=true':'&mature=false');
  try{
    const r=await fetch(u); if(!r.ok) return [];
    const j=await r.json();
    return (j.results||[]).map(it=>({src:it.thumbnail||it.url, creditUrl:it.foreign_landing_url||it.url}));
  }catch(e){ return []; }
}

// ---- Source combining (priority: local file → repo pics → user-added (LS) → Wikidata → Openverse) ----
async function loadPrimary(name){
  if(cachePrimary[name]) return cachePrimary[name];
  const key = name;
  // 1) user-added (localStorage)
  if(localGallery[key] && localGallery[key].length) {
    cachePrimary[name] = { src: localGallery[key][0], creditUrl: 'lokal' };
    return cachePrimary[name];
  }
  // 2) repo mapping
  if(localMap[name] && localMap[name].length){
    cachePrimary[name] = { src: localMap[name][0], creditUrl: localMap[name][0] };
    return cachePrimary[name];
  }
  // 3) Wikidata
  const qid = await wikidataLookup(name);
  if(qid){
    try{
      const e = await fetch(WD_GET + encodeURIComponent(qid)).then(r=>r.json()).catch(()=>null);
      const ent = e && e.entities && e.entities[qid];
      const fn = claimImageFilename(ent);
      if(fn){ cachePrimary[name] = { src: commonsFileURL(fn, 500), creditUrl: 'https://www.wikidata.org/wiki/'+qid }; return cachePrimary[name]; }
    }catch(e){}
  }
  // 4) Openverse
  const ov = await openverseThumbs(name,1, adultEl.checked);
  cachePrimary[name] = ov[0] || { src: 'pics/placeholder.png', creditUrl: '#' };
  return cachePrimary[name];
}

async function loadGallery(name){
  if(cacheGalleries[name]) return cacheGalleries[name];
  const key=name;
  let imgs=[];
  // 1) user-added
  if(localGallery[key] && localGallery[key].length){
    imgs = imgs.concat(localGallery[key].map(u=>({src:u, creditUrl:'lokal'})));
  }
  // 2) repo mapping
  if(localMap[name] && localMap[name].length){
    imgs = imgs.concat(localMap[name].map(u=>({src:u, creditUrl:u})));
  }
  // 3) wikidata/commons
  const qid = await wikidataLookup(name);
  if(qid){
    try{
      const e = await fetch(WD_GET + encodeURIComponent(qid)).then(r=>r.json()).catch(()=>null);
      const ent = e && e.entities && e.entities[qid];
      const cat = claimCommonsCategory(ent);
      const fn = claimImageFilename(ent);
      if(fn) imgs.unshift({src: commonsFileURL(fn, 600), creditUrl: 'https://www.wikidata.org/wiki/'+qid});
      if(cat){
        const cms = await commonsCategoryThumbs(cat, 12, 360);
        imgs = imgs.concat(cms);
      }
    }catch(e){}
  }
  // 4) openverse
  const ov = await openverseThumbs(name, 12, adultEl.checked);
  imgs = imgs.concat(ov);
  // dedupe
  const seen=new Set(), out=[];
  imgs.forEach(it=>{ if(it && it.src){ const k=it.src.toLowerCase(); if(!seen.has(k)){ seen.add(k); out.push(it); } } });
  cacheGalleries[name]=out;
  return out;
}

function pill(name, toBox){
  const div=document.createElement('div');div.className='pill';
  const img=document.createElement('img');img.className='thumb';div.appendChild(img);
  div.appendChild(document.createTextNode(' '+name)); toBox.appendChild(div);
  (async()=>{const p=await loadPrimary(name); if(p&&p.src) img.src=p.src; })();
}

function renderLists(){
  cntIn.textContent=pool.length; cntOut.textContent=out.length;
  listIn.innerHTML=''; listOut.innerHTML='';
  pool.forEach(n=>pill(n,listIn)); out.forEach(n=>pill(n,listOut));
}

function renderAddBar(whichName, whichSide){
  const hostEl = whichSide==='L'? lhost : rhost;
  hostEl.textContent = '–';
  hostEl.title = '';
}

async function renderSide(name, bigImgEl, galEl, linkEl, side){
  bigImgEl.removeAttribute('src'); linkEl.href='#';
  renderAddBar(name, side);
  const primary = await loadPrimary(name);
  if(primary){ bigImgEl.src = primary.src; linkEl.href = primary.creditUrl || '#'; }
  const imgs = await loadGallery(name);
  galEl.innerHTML='';
  imgs.forEach(it=>{
    const im=document.createElement('img'); im.src=it.src; im.title = (it.creditUrl==='lokal'?'Lokal':hostOf(it.creditUrl||it.src));
    im.addEventListener('click', ()=>{ bigImgEl.src=it.src; linkEl.href = it.creditUrl || it.src; const hostEl = side==='L'? lhost : rhost; hostEl.textContent = im.title; });
    im.addEventListener('dblclick', ()=> lightbox(it.src));
    galEl.appendChild(im);
  });
}

function drawPair(){
  if(pool.length<=1) return;
  const a=Math.floor(Math.random()*pool.length);
  let b=Math.floor(Math.random()*pool.length); while(b===a) b=Math.floor(Math.random()*pool.length);
  currentPair=[pool[a],pool[b]];
  leftBtn.textContent=currentPair[0]; rightBtn.textContent=currentPair[1];
  renderSide(currentPair[0], li, lgal, lg, 'L');
  renderSide(currentPair[1], ri, rgal, rg, 'R');
  status.textContent = pool.length + ' aktiv | Ziel: ' + target + (adultEl.checked ? ' | Erw. an' : '');
  arena.style.display='block';
}

function start(){
  pool = uniq(namesEl.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean));
  out=[]; history=[]; target=Math.max(1,parseInt(targetEl.value||'1',10));
  if(pool.length<2||target>=pool.length){ alert('Mind. 2 unterschiedliche Namen & Ziel kleiner als Anzahl.'); return; }
  renderLists(); drawPair(); undoBtn.disabled=true; result.style.display='none';
}

function pick(idx){
  if(currentPair.length<2) return;
  const w=currentPair[idx], l=currentPair[1-idx];
  pool = pool.filter(n=>n!==w && n!==l); pool.push(w); out.push(l); history.push({w,l}); undoBtn.disabled=false;
  if(pool.length<=target){ showResult(); return; }
  renderLists(); drawPair();
}

function undo(){
  const h=history.pop(); if(!h) return;
  pool = pool.filter(n=>n!==h.w); const j = out.lastIndexOf(h.l); if(j>-1) out.splice(j,1);
  pool.push(h.w,h.l); undoBtn.disabled = history.length===0; renderLists(); drawPair();
}

function showResult(){
  arena.style.display='none'; result.style.display='block'; survivors.innerHTML='';
  pool.forEach(async n=>{
    const el=document.createElement('div'); el.className='pill';
    const img=document.createElement('img'); img.className='thumb'; el.appendChild(img);
    el.appendChild(document.createTextNode(' '+n));
    survivors.appendChild(el);
    const p=await loadPrimary(n); if(p&&p.src) img.src=p.src;
  });
}

// ----- Add image (URL or File) -----
function addImageFlow(which){ // which='L'|'R'
  const name = which==='L'? currentPair[0] : currentPair[1];
  const url = prompt('Bild-URL einfügen (oder abbrechen und Datei wählen)');
  if(url && /^https?:\/\//i.test(url)){
    (localGallery[name] = localGallery[name] || []).unshift(url);
    saveLocal(); drawPair(); return;
  }
  // else choose file
  const input = which==='L'? lfile : rfile;
  input.onchange = async () => {
    const f = input.files && input.files[0]; if(!f) return;
    const dataUrl = await fileToDataURL(f, 640);
    (localGallery[name] = localGallery[name] || []).unshift(dataUrl);
    saveLocal(); drawPair();
    input.value = '';
  };
  input.click();
}

startBtn.onclick = start;
demoBtn.onclick = ()=>{ namesEl.value = ['Mia Malkova','Johnny Sins','Margot Robbie','Tom Cruise','Ariana Grande','Zendaya'].join('\n'); };
leftBtn.onclick = ()=> pick(0); rightBtn.onclick = ()=> pick(1);
undoBtn.onclick = undo; shuffleBtn.onclick = drawPair;
ladd.onclick = ()=> addImageFlow('L'); radd.onclick = ()=> addImageFlow('R');

// init
loadLocal(); loadRepoMapping();
</script>
</body>
</html>
